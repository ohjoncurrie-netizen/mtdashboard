<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Montana Insight Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script async defer 
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXY5noMi8eAp2uM9zWOMHYGRC_k_PeRU0&libraries=geometry&callback=initGoogleMaps"
  type="text/javascript"></script>
  <script type="module" src="/src/main.jsx"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="modern-enhancements.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-logo">MT</div>
        <h2>Montana Insight Portal</h2>
      </div>
      <button class="sidebar-close" id="sidebar-close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    
    <nav class="sidebar-nav">
      <span class="sidebar-nav-label">Navigation</span>
      <ul>
        <li><a href="#map-section" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg> View Map</a></li>
        <li><a href="#" id="sidebar-directory" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg> Browse Counties</a></li>
        <li><a href="#" id="sidebar-business" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg> Business Directory</a></li>
        <li><a href="#" id="sidebar-marketplace" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg> Marketplace üîí</a></li>
        <li><a href="https://511.mt.gov/" target="_blank" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> Road Conditions</a></li>
        <li><a href="https://visitmt.com/" target="_blank" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg> Visit Montana</a></li>
        <li><a href="https://fwp.mt.gov/" target="_blank" class="sidebar-link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg> Fish, Wildlife & Parks</a></li>
      </ul>
    </nav>
    
    <div class="sidebar-facts">
      <span class="sidebar-nav-label">Quick Facts</span>
      <div class="fact-item">
        <h4>The Treasure State</h4>
        <p>Montana's nickname comes from its rich mineral reserves, including gold, silver, and copper.</p>
      </div>
      <div class="fact-item">
        <h4>Big Sky Country</h4>
        <p>Montana is the 4th largest state with 147,040 square miles of stunning landscapes.</p>
      </div>
      <div class="fact-item">
        <h4>Capital City</h4>
        <p>Helena is the state capital, while Billings is the largest city.</p>
      </div>
      <div class="fact-item">
        <h4>Glacier National Park</h4>
        <p>Home to over 700 miles of hiking trails and 26 glaciers (as of 2015).</p>
      </div>
      <div class="fact-item">
        <h4>Wildlife Paradise</h4>
        <p>Montana has more cattle than people and is home to grizzly bears, wolves, elk, and bison.</p>
      </div>
      <div class="fact-item">
        <h4>Statehood</h4>
        <p>Montana became the 41st state on November 8, 1889.</p>
      </div>
      <div class="fact-item">
        <h4>Agriculture</h4>
        <p>Montana is a leading producer of wheat, barley, and lentils in the United States.</p>
      </div>
      <div class="fact-item">
        <h4>Film Location</h4>
        <p>Many movies filmed here including "A River Runs Through It" and "The Revenant".</p>
      </div>
    </div>
    <!-- Mobile Auth Section -->
    <div class="sidebar-auth" id="sidebar-auth-section">
      <!-- Shown when logged OUT -->
      <div id="sidebar-auth-guest">
        <span class="sidebar-nav-label">Account</span>
        <button class="sidebar-auth-btn sidebar-signin-btn" id="sidebar-signin-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
          Sign In
        </button>
        <button class="sidebar-auth-btn sidebar-register-btn" id="sidebar-register-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
          Create Account
        </button>
      </div>
      <!-- Shown when logged IN -->
      <div id="sidebar-auth-user" style="display:none;">
        <span class="sidebar-nav-label">Account</span>
        <div class="sidebar-user-card">
          <span class="sidebar-user-avatar" id="sidebar-user-avatar">üë§</span>
          <div class="sidebar-user-info">
            <span class="sidebar-user-name" id="sidebar-user-name">User</span>
            <span class="sidebar-user-email" id="sidebar-user-email"></span>
          </div>
        </div>
        <button class="sidebar-auth-btn sidebar-profile-btn" id="sidebar-profile-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          My Profile
        </button>
        <button class="sidebar-auth-btn sidebar-signout-btn" id="sidebar-signout-btn-mobile">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Sign Out
        </button>
      </div>
    </div>

    <a href="#" id="sidebar-admin" class="sidebar-link" style="display:block; padding: 12px 20px; font-size: 0.75rem; opacity: 0.45; margin-top: 8px;">‚öôÔ∏è Admin Panel</a>
  </aside>
  
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  
  <div class="container">
    <header>
      <div class="header-top">
        <div class="header-brand">
          <button id="sidebar-toggle" class="nav-btn menu-btn" aria-label="Menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="header-content">
            <h1>Montana Insight Portal</h1>
            <p class="subtitle">Statewide Intelligence, Discovery & Community Portal</p>
          </div>
        </div>
        <nav class="header-nav">
          <button id="directory-btn" class="nav-btn">Browse Counties</button>
          <button id="business-btn" class="nav-btn">Business Directory</button>
          <button id="marketplace-nav-btn" class="nav-btn">üõí Marketplace</button>
          <button id="discussion-btn" class="nav-btn">üí¨ Discussion</button>
          <button id="events-nav-btn" class="nav-btn">üìÖ Events</button>
          <button id="awards-btn" class="nav-btn">üèÜ Top 20</button>
          <button id="hud-toggle-btn" class="nav-btn">üí° Facts</button>
          <div class="auth-nav" id="auth-nav">
            <button id="auth-signin-btn" class="nav-btn auth-btn">Sign In</button>
            <button id="auth-register-btn" class="nav-btn auth-btn accent">Register</button>
          </div>
          <div class="user-nav" id="user-nav" style="display: none;">
            <button id="user-profile-btn" class="nav-btn user-btn"><span id="user-avatar-emoji">üë§</span> <span id="user-display-name">Profile</span></button>
            <button id="user-signout-btn" class="nav-btn">Sign Out</button>
          </div>
        </nav>
      </div>
    </header>

    <main>
      <!-- Breadcrumbs -->
      <section class="breadcrumb-section" id="breadcrumb-section">
        <nav class="breadcrumb" aria-label="Breadcrumb">
          <a href="#/montana" id="breadcrumb-montana">Montana</a>
          <span class="breadcrumb-sep" id="breadcrumb-sep-county">/</span>
          <a href="#/montana" id="breadcrumb-county" class="breadcrumb-link disabled">County</a>
          <span class="breadcrumb-sep" id="breadcrumb-sep-city">/</span>
          <span id="breadcrumb-city" class="breadcrumb-current">City</span>
        </nav>
      </section>

      <!-- County Directory -->
      <section class="directory-section" id="directory-section" style="display: none;">
        <div class="card">
          <div class="directory-header">
            <h2>Browse Montana Counties</h2>
            <div class="directory-controls">
              <input type="text" id="directory-search" class="search-input" placeholder="Search counties...">
              <button class="nav-btn" id="directory-back-map">Back to Map</button>
            </div>
          </div>
          <div class="directory-grid" id="directory-grid">
            <p class="empty-state">Loading counties...</p>
          </div>
        </div>
      </section>

      <!-- County Page -->
      <section class="county-page" id="county-page" style="display: none;">
        <div class="card county-card">
          <div class="county-hero" id="county-hero" style="display: none;">
            <img id="county-hero-image" src="" alt="" class="hero-image">
          </div>
          <div class="county-header">
            <h2 id="county-page-title">County</h2>
            <div class="county-actions">
              <button class="nav-btn" id="county-back-map">Back to Map</button>
              <button class="nav-btn" id="county-open-admin">Edit in Admin</button>
            </div>
          </div>
          <p id="county-page-description" class="county-description"></p>
          <div class="county-meta" id="county-meta"></div>
          <div class="county-cities">
            <h3>Cities & Towns</h3>
            <div id="county-cities-list" class="chip-list"></div>
          </div>
          <div class="county-events">
            <h3>üìÖ Events & Activities</h3>
            <div id="county-events-list" class="events-grid"></div>
          </div>
        </div>
      </section>

      <!-- City Page (full page, replaces modal for deep links) -->
      <section class="city-page" id="city-page" style="display: none;">
        <div class="card city-card">
          <div class="city-hero" id="city-hero" style="display: none;">
            <img id="city-hero-image" src="" alt="" class="hero-image">
          </div>
          <div class="city-header">
            <h2 id="city-page-title">City</h2>
            <div class="city-actions">
              <button class="nav-btn" id="city-back-county">Back to County</button>
              <button class="nav-btn" id="city-open-admin" style="display:none;">Edit City</button>
            </div>
          </div>
          <p id="city-page-county-label" class="city-county-label"></p>
          <p id="city-page-description" class="city-description"></p>
          <div class="city-meta" id="city-meta"></div>
          <div class="city-section">
            <h3>Activities & Attractions</h3>
            <p id="city-page-activities" class="city-activities"></p>
          </div>
          <div class="city-section">
            <h3>Highlights</h3>
            <p id="city-page-highlights" class="city-highlights"></p>
          </div>
          <div class="city-section">
            <h3>Local Businesses</h3>
            <div id="city-page-businesses" class="businesses-list"></div>
          </div>
          <div class="city-section">
            <h3>üìÖ Events & Activities</h3>
            <div id="city-events-list" class="events-grid"></div>
          </div>
        </div>
      </section>

      <!-- Marketplace Section -->
      <section class="marketplace-section" id="marketplace-section" style="display: none;">
        <div class="card marketplace-card">
          <div class="marketplace-header">
            <h2>Montana Marketplace</h2>
            <div class="marketplace-actions">
              <button class="nav-btn" id="marketplace-back-btn">Back to Map</button>
              <button class="submit-btn" id="marketplace-post-btn" style="display: none;">+ Post an Ad</button>
            </div>
          </div>

          <!-- Auth Required Message (shown when not logged in) -->
          <div id="marketplace-auth-required" class="auth-required-card" style="display: none;">
            <div class="auth-icon">üîí</div>
            <h3>Authentication Required</h3>
            <p>Please sign in to view and post marketplace listings.</p>
            <div class="auth-actions">
              <button class="submit-btn" id="marketplace-signin-btn">Sign In</button>
              <button class="nav-btn" id="marketplace-register-btn">Create Account</button>
            </div>
          </div>

          <!-- Marketplace Content (shown when logged in) -->
          <div id="marketplace-content" style="display: none;">
            <div class="marketplace-intro">
              <p>Buy, sell, and find work opportunities across Montana communities. Connect with locals in your county and beyond.</p>
            </div>

            <!-- Filters -->
            <div class="marketplace-filters">
              <div class="form-row">
                <div class="form-group">
                  <label>Category</label>
                  <select id="marketplace-filter-type" class="search-input">
                    <option value="">All Categories</option>
                    <option value="buying">üîç Buy</option>
                    <option value="selling">üè∑Ô∏è Sell</option>
                    <option value="for_hire">üë∑ For Hire</option>
                    <option value="for_sale">üì¶ For Sale</option>
                    <option value="community">üì£ Community Announcements</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>County</label>
                  <select id="marketplace-filter-county" class="search-input">
                    <option value="">All Counties</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Search</label>
                  <input type="text" id="marketplace-search" placeholder="Search listings..." class="search-input">
                </div>
              </div>
            </div>

            <!-- Listings Grid -->
            <div id="marketplace-listings" class="marketplace-grid">
              <p class="empty-state">No listings yet. Be the first to post!</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Admin Panel -->
      <section class="admin-section" id="admin-section" style="display: none;">
        <!-- Login Screen -->
        <div class="card admin-login" id="admin-login">
          <h2>Admin Login</h2>
          <div id="admin-login-error" class="error-message" style="display: none;"></div>
          <form id="admin-login-form">
            <div class="form-group" id="admin-email-group">
              <label>Email</label>
              <input type="email" id="admin-email" placeholder="admin@example.com" required>
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" id="admin-password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="submit-btn">Login</button>
            <p class="form-note" id="admin-login-note"></p>
          </form>
        </div>

        <!-- Admin Dashboard -->
        <div class="admin-dashboard" id="admin-dashboard" style="display: none;">
          <div class="card">
            <div class="admin-header">
              <h2>County Editor</h2>
              <div>
                <button id="admin-logout-btn" class="nav-btn">Logout</button>
                <button id="admin-settings-btn" class="nav-btn">Settings</button>
              </div>
            </div>
            
            <div class="admin-tabs">
              <button class="admin-tab active" data-tab="counties">Edit Counties</button>
              <button class="admin-tab" data-tab="cities">Edit Cities</button>
              <button class="admin-tab" data-tab="events">Events</button>
              <button class="admin-tab" data-tab="community-awards">Community Awards</button>
              <button class="admin-tab" data-tab="users">Manage Users</button>
              <button class="admin-tab" data-tab="analytics">üìä Analytics</button>
              <button class="admin-tab" data-tab="settings">Settings</button>
            </div>

            <!-- Counties Tab -->
            <div class="admin-tab-content" id="tab-counties">
              <div class="admin-help-box">
                <h4>üóÇÔ∏è County List & Quick Edit</h4>
                <p>Use search, review completion status, and click <strong>Edit County</strong> to update county content fields.</p>
              </div>
              <div class="admin-search">
                <input type="text" id="county-search" placeholder="Search counties..." class="search-input">
              </div>
              <p class="admin-list-summary" id="county-list-summary">Loading county summary...</p>
              
              <div class="county-list" id="county-list">
                <p class="empty-state">Loading counties...</p>
              </div>
            </div>

            <!-- Cities Tab -->
            <div class="admin-tab-content" id="tab-cities" style="display: none;">
              <div class="admin-search">
                <div class="form-row">
                  <div class="form-group">
                    <label>County</label>
                    <select id="city-admin-county" class="search-input">
                      <option value="">Select County...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Search</label>
                    <input type="text" id="city-admin-search" placeholder="Search cities..." class="search-input">
                  </div>
                </div>
              </div>
              <div class="county-list" id="city-list">
                <p class="empty-state">Select a county to see its cities.</p>
              </div>
            </div>

            <!-- Events Tab -->
            <div class="admin-tab-content" id="tab-events" style="display: none;">
              <div class="admin-help-box">
                <h4>üí° Events Management</h4>
                <p>Add and manage local events, festivals, business promotions, and outdoor activities for each county and city.</p>
              </div>
              <div class="admin-header-bar">
                <div class="admin-search">
                  <select id="event-filter-county" class="search-input" style="max-width: 200px;">
                    <option value="">All Counties</option>
                  </select>
                  <select id="event-filter-type" class="search-input" style="max-width: 200px;">
                    <option value="">All Types</option>
                    <option value="community">üéâ Community Events</option>
                    <option value="business">üè™ Business Events</option>
                    <option value="historical">üìú Historical Facts</option>
                    <option value="outdoor">üèîÔ∏è Outdoor Activities</option>
                  </select>
                  <input type="text" id="event-search" placeholder="Search events..." class="search-input" style="max-width: 250px;">
                </div>
                <button id="add-event-btn" class="submit-btn">+ Add Event</button>
              </div>
              <div class="event-list" id="event-list">
                <p class="empty-state">No events yet. Click "+ Add Event" to create one.</p>
              </div>
            </div>

            <!-- Community Awards Tab -->
            <div class="admin-tab-content" id="tab-community-awards" style="display: none;">
              <div class="admin-help-box">
                <h4>üèÜ Community Awards Management</h4>
                <p>Grant awards to community members for quizzes, knowledge contributions, helpful routes, and other achievements.</p>
              </div>
              <div class="admin-awards-layout">
                <!-- Member Selector -->
                <div class="award-grant-section">
                  <h4>Grant Award to Member</h4>
                  <div class="form-group">
                    <label>Select Member</label>
                    <select id="award-member-select" class="search-input">
                      <option value="">Choose a member...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Select Award</label>
                    <select id="award-type-select" class="search-input">
                      <option value="">Choose an award...</option>
                    </select>
                  </div>
                  <div id="award-preview" class="award-preview" style="display: none;">
                    <span class="award-preview-icon" id="award-preview-icon"></span>
                    <div class="award-preview-details">
                      <strong id="award-preview-name"></strong>
                      <p id="award-preview-desc"></p>
                      <span class="award-preview-points" id="award-preview-points"></span>
                    </div>
                  </div>
                  <button id="grant-award-btn" class="submit-btn" disabled>Grant Award</button>
                </div>

                <!-- Member Awards List -->
                <div class="member-awards-overview">
                  <h4>Member Profiles & Awards</h4>
                  <input type="text" id="admin-member-search" placeholder="Search members..." class="search-input">
                  <div id="admin-member-list" class="admin-member-list">
                    <p class="empty-state">Loading members...</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manage Users Tab -->
            <div class="admin-tab-content" id="tab-users" style="display: none;">
              <div class="admin-help-box">
                <h4>üí° User Management</h4>
                <p id="user-help-text">Multi-user authentication requires Firebase. Configure Firebase in firebase-config.js to enable this feature.</p>
              </div>
              <div class="admin-header-bar" id="users-header" style="display: none;">
                <button id="add-user-btn" class="submit-btn">+ Add New User</button>
              </div>
              <div class="user-list" id="user-list">
                <p class="empty-state">Loading users...</p>
              </div>
            </div>

            <!-- Analytics Tab -->
            <div class="admin-tab-content" id="tab-analytics" style="display: none;">
              <div class="analytics-header">
                <h3 class="analytics-title">üìä Site Analytics</h3>
                <button class="analytics-refresh-btn" onclick="window.mtApp.renderAnalyticsDashboard()">‚Üª Refresh</button>
              </div>

              <!-- Summary Cards -->
              <div class="analytics-summary" id="analytics-summary">
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-total-views">‚Äî</div>
                  <div class="analytics-card-label">Total Page Views</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-today-views">‚Äî</div>
                  <div class="analytics-card-label">Views Today</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-county-views">‚Äî</div>
                  <div class="analytics-card-label">County Views</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-city-views">‚Äî</div>
                  <div class="analytics-card-label">City Views</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-discussions">‚Äî</div>
                  <div class="analytics-card-label">Discussion Posts</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card-value" id="stat-events-created">‚Äî</div>
                  <div class="analytics-card-label">Events Posted</div>
                </div>
              </div>

              <!-- Two-column charts -->
              <div class="analytics-charts">
                <div class="analytics-chart-panel">
                  <h4 class="analytics-chart-title">üèîÔ∏è Top Counties by Views</h4>
                  <div id="chart-top-counties" class="analytics-bar-chart">
                    <p class="empty-state">No data yet.</p>
                  </div>
                </div>
                <div class="analytics-chart-panel">
                  <h4 class="analytics-chart-title">üèòÔ∏è Top Cities by Views</h4>
                  <div id="chart-top-cities" class="analytics-bar-chart">
                    <p class="empty-state">No data yet.</p>
                  </div>
                </div>
              </div>

              <!-- Most active discussions -->
              <div class="analytics-section">
                <h4 class="analytics-chart-title">üí¨ Most Active Discussions</h4>
                <div id="analytics-discussions" class="analytics-discussions">
                  <p class="empty-state">No discussions yet.</p>
                </div>
              </div>

              <!-- Recent activity feed -->
              <div class="analytics-section">
                <h4 class="analytics-chart-title">üïí Recent Activity</h4>
                <div id="analytics-feed" class="analytics-feed">
                  <p class="empty-state">No activity recorded yet.</p>
                </div>
              </div>

              <!-- Billing dashboard -->
              <div class="analytics-section">
                <h4 class="analytics-chart-title">üí≥ Billing Dashboard</h4>
                <div class="analytics-summary" id="billing-summary">
                  <div class="analytics-card">
                    <div class="analytics-card-value" id="bill-total-businesses">‚Äî</div>
                    <div class="analytics-card-label">Total Businesses</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-value" id="bill-active">‚Äî</div>
                    <div class="analytics-card-label">Active Billing</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-value" id="bill-past-due">‚Äî</div>
                    <div class="analytics-card-label">Past Due</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-value" id="bill-canceled">‚Äî</div>
                    <div class="analytics-card-label">Canceled</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-value" id="bill-mrr">‚Äî</div>
                    <div class="analytics-card-label">Estimated MRR</div>
                  </div>
                </div>
                <div id="billing-breakdown" class="analytics-discussions">
                  <p class="empty-state">No billing data yet.</p>
                </div>
              </div>
            </div>

            <!-- Settings Tab -->
            <div class="admin-tab-content" id="tab-settings" style="display: none;">
              <form id="admin-settings-form">
                <div class="form-group">
                  <label>Change Admin Password</label>
                  <input type="password" id="new-password" placeholder="New password">
                </div>
                <div class="form-group">
                  <label>Confirm Password</label>
                  <input type="password" id="confirm-password" placeholder="Confirm password">
                </div>
                <button type="submit" class="submit-btn">Update Password</button>
              </form>
            </div>
          </div>
        </div>

        <!-- City Edit Modal -->
        <div class="modal" id="city-edit-modal" style="display: none;">
          <div class="modal-content card">
            <div class="modal-header">
              <h3 id="modal-city-name">Edit City</h3>
              <button class="modal-close" id="city-modal-close-btn">&times;</button>
            </div>
            <form id="city-edit-form">
              <input type="hidden" id="edit-city-fips">
              <input type="hidden" id="edit-city-slug">

              <div class="form-group">
                <label>City Name (Read-only)</label>
                <input type="text" id="edit-city-display-name" disabled>
              </div>

              <div class="form-group">
                <label>Description</label>
                <textarea id="edit-city-description" rows="4" placeholder="Add a description about this city..."></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Population</label>
                  <input type="text" id="edit-city-population" placeholder="e.g., 53,293">
                </div>
                <div class="form-group">
                  <label>Elevation</label>
                  <input type="text" id="edit-city-elevation" placeholder="e.g., 4,820 ft">
                </div>
              </div>

              <div class="form-group">
                <label>Website URL</label>
                <input type="text" id="edit-city-website" placeholder="https://example.com">
              </div>

              <div class="form-group">
                <label>Hero Image URL</label>
                <input type="text" id="edit-city-hero-image" placeholder="https://example.com/image.jpg">
                <small style="color: var(--mt-slate-500); font-size: 0.85rem;">Add a scenic image of or related to this city</small>
              </div>

              <div class="form-group">
                <label>Activities (comma-separated)</label>
                <input type="text" id="edit-city-activities" placeholder="Skiing, Hiking, Fishing">
              </div>

              <div class="form-group">
                <label>Highlights (comma-separated)</label>
                <input type="text" id="edit-city-highlights" placeholder="State University, Museum, etc.">
              </div>

              <div class="modal-footer">
                <button type="button" class="nav-btn" id="city-modal-cancel-btn">Cancel</button>
                <button type="submit" class="submit-btn">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- County Edit Modal -->
        <div class="modal" id="county-edit-modal" style="display: none;">
          <div class="modal-content card">
            <div class="modal-header">
              <h3 id="modal-county-name">Edit County</h3>
              <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <form id="county-edit-form">
              <input type="hidden" id="edit-county-id">
              
              <div class="form-group">
                <label>County Name (Read-only)</label>
                <input type="text" id="edit-county-display-name" disabled>
              </div>
              
              <div class="form-group">
                <label>Description</label>
                <textarea id="edit-county-description" rows="4" placeholder="Add a description about this county..."></textarea>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Population</label>
                  <input type="text" id="edit-county-population" placeholder="e.g., 45,000">
                </div>
                <div class="form-group">
                  <label>County Seat</label>
                  <input type="text" id="edit-county-seat" placeholder="e.g., Bozeman">
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Established Year</label>
                  <input type="text" id="edit-county-established" placeholder="e.g., 1864">
                </div>
                <div class="form-group">
                  <label>Area (sq mi)</label>
                  <input type="text" id="edit-county-area" placeholder="e.g., 2,500">
                </div>
              </div>
              
              <div class="form-group">
                <label>Website URL</label>
                <input type="text" id="edit-county-website" placeholder="https://example.com">
              </div>

              <div class="form-group">
                <label>Hero Image URL</label>
                <input type="text" id="edit-county-hero-image" placeholder="https://example.com/image.jpg">
                <small style="color: var(--mt-slate-500); font-size: 0.85rem;">Add a scenic image of or related to this county</small>
              </div>
              
              <div class="form-group">
                <label>Points of Interest (comma-separated)</label>
                <input type="text" id="edit-county-poi" placeholder="Yellowstone, Glacier Park, etc.">
              </div>
              
              <div class="modal-footer">
                <button type="button" class="nav-btn" id="modal-cancel-btn">Cancel</button>
                <button type="submit" class="submit-btn">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Discussion Edit Modal -->
        <div class="modal" id="discussion-edit-modal" style="display: none;">
          <div class="modal-content card">
            <div class="modal-header">
              <h3>Edit Post</h3>
              <button class="modal-close" id="discussion-edit-close-btn">&times;</button>
            </div>
            <form id="discussion-edit-form">
              <input type="hidden" id="edit-post-id">
              <div class="form-group">
                <label>Topic</label>
                <input type="text" id="edit-post-topic" maxlength="100" required>
              </div>
              <div class="form-group">
                <label>Message</label>
                <textarea id="edit-post-message" rows="4" maxlength="500" required></textarea>
              </div>
              <div class="form-group">
                <label>Category</label>
                <select id="edit-post-category" required>
                  <option value="wildlife">ü¶å Wildlife &amp; Nature</option>
                  <option value="history">üìú History &amp; Culture</option>
                  <option value="hiking">üèîÔ∏è Hiking &amp; Outdoor</option>
                  <option value="cities">üèòÔ∏è Cities &amp; Towns</option>
                  <option value="geology">ü™® Geology &amp; Geography</option>
                  <option value="tips">üí° Local Tips &amp; Advice</option>
                  <option value="general">üó®Ô∏è General Discussion</option>
                </select>
              </div>
              <div class="modal-footer">
                <button type="button" class="nav-btn" id="discussion-edit-cancel-btn">Cancel</button>
                <button type="submit" class="submit-btn">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Add User Modal -->
        <div class="modal" id="add-user-modal" style="display: none;">
          <div class="modal-content card">
            <div class="modal-header">
              <h3 id="user-modal-title">Add New Admin User</h3>
              <button class="modal-close" id="user-modal-close-btn">&times;</button>
            </div>
            <form id="add-user-form">
              <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="new-user-email" placeholder="admin@example.com" required>
              </div>

              <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="new-user-name" placeholder="John Doe">
              </div>

              <div class="form-group">
                <label>Temporary Password *</label>
                <input type="password" id="new-user-password" placeholder="Minimum 6 characters" required>
                <p class="form-note">User should change this password on first login.</p>
              </div>

              <div class="form-group">
                <label>Role</label>
                <select id="new-user-role">
                  <option value="admin">Admin (Full Access)</option>
                  <option value="editor">Editor (Content Only)</option>
                </select>
              </div>

              <div class="modal-footer">
                <button type="button" class="nav-btn" id="user-modal-cancel-btn">Cancel</button>
                <button type="submit" class="submit-btn">Add User</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Event Edit Modal -->
        <div class="modal" id="event-edit-modal" style="display: none;">
          <div class="modal-content card" style="max-width: 700px;">
            <div class="modal-header">
              <h3 id="event-modal-title">Add Event</h3>
              <button class="modal-close" id="event-modal-close-btn">&times;</button>
            </div>
            <form id="event-edit-form">
              <input type="hidden" id="edit-event-id">

              <div class="form-group">
                <label>Event Name *</label>
                <input type="text" id="edit-event-name" placeholder="Montana State Fair" required>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Event Type *</label>
                  <select id="edit-event-type" required>
                    <option value="community">üéâ Community Event</option>
                    <option value="business">üè™ Business Event</option>
                    <option value="historical">üìú Historical Fact</option>
                    <option value="outdoor">üèîÔ∏è Outdoor Activity</option>
                  </select>
                </div>
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="edit-event-featured">
                    Featured Event
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label>Description *</label>
                <textarea id="edit-event-description" rows="4" placeholder="Describe the event..." required></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>County *</label>
                  <select id="edit-event-county" required>
                    <option value="">Select County...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>City (optional)</label>
                  <select id="edit-event-city">
                    <option value="">County-wide</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Start Date</label>
                  <input type="date" id="edit-event-start">
                </div>
                <div class="form-group">
                  <label>End Date (optional)</label>
                  <input type="date" id="edit-event-end">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Recurring</label>
                  <select id="edit-event-recurring">
                    <option value="">One-time</option>
                    <option value="annual">Annual</option>
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Price</label>
                  <input type="text" id="edit-event-price" placeholder="Free or $10-25">
                </div>
              </div>

              <div class="form-group">
                <label>Address/Location</label>
                <input type="text" id="edit-event-address" placeholder="Event venue or location">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Website</label>
                  <input type="url" id="edit-event-website" placeholder="https://example.com">
                </div>
                <div class="form-group">
                  <label>Contact Email</label>
                  <input type="email" id="edit-event-email" placeholder="info@example.com">
                </div>
              </div>

              <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" id="edit-event-phone" placeholder="(406) 555-1234">
              </div>

              <div class="modal-footer">
                <button type="button" class="nav-btn" id="event-modal-cancel-btn">Cancel</button>
                <button type="button" class="nav-btn danger" id="event-delete-btn" style="display: none;">Delete Event</button>
                <button type="submit" class="submit-btn">Save Event</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Marketplace Post Modal -->
        <div class="modal" id="marketplace-post-modal" style="display: none;">
          <div class="modal-content card" style="max-width: 700px;">
            <div class="modal-header">
              <h3 id="marketplace-modal-title">Post Listing</h3>
              <button class="modal-close" id="marketplace-modal-close-btn">&times;</button>
            </div>
            <form id="marketplace-post-form">
              <input type="hidden" id="edit-listing-id">

              <div class="form-group">
                <label>Category *</label>
                <select id="edit-listing-type" required>
                  <option value="">Select category...</option>
                  <option value="buying">üîç Buy</option>
                  <option value="selling">üè∑Ô∏è Sell</option>
                  <option value="for_hire">üë∑ For Hire</option>
                  <option value="for_sale">üì¶ For Sale</option>
                  <option value="community">üì£ Community Announcements</option>
                </select>
              </div>

              <div class="form-group">
                <label>Title *</label>
                <input type="text" id="edit-listing-title" placeholder="E.g., Used Truck for Sale, Seeking Ranch Hand" required maxlength="100">
              </div>

              <div class="form-group">
                <label>Description *</label>
                <textarea id="edit-listing-description" rows="5" placeholder="Provide details about your listing..." required maxlength="1000"></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Price (optional)</label>
                  <input type="text" id="edit-listing-price" placeholder="$1,000 or Best Offer">
                </div>
                <div class="form-group">
                  <label>County *</label>
                  <select id="edit-listing-county" required>
                    <option value="">Select county...</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Location (Montana City/County) *</label>
                <input type="text" id="edit-listing-location" placeholder="E.g., Great Falls, Missoula County" required>
              </div>

              <div class="form-group">
                <label>Image *</label>
                <input type="file" id="edit-listing-image" accept="image/*">
                <small class="form-note">Upload at least one image for your post.</small>
              </div>

              <div class="form-group">
                <label>Contact Name *</label>
                <input type="text" id="edit-listing-contact-name" placeholder="Your name" required>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Contact Email *</label>
                  <input type="email" id="edit-listing-contact-email" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="edit-listing-contact-phone" placeholder="(406) 555-1234">
                </div>
              </div>

              <div class="form-group">
                <label>Listing Duration</label>
                <select id="edit-listing-duration">
                  <option value="7">7 days</option>
                  <option value="14">14 days</option>
                  <option value="30" selected>30 days</option>
                  <option value="60">60 days</option>
                  <option value="90">90 days</option>
                </select>
              </div>

              <div class="modal-footer">
                <button type="button" class="nav-btn" id="marketplace-modal-cancel-btn">Cancel</button>
                <button type="button" class="nav-btn danger" id="marketplace-delete-btn" style="display: none;">Delete Listing</button>
                <button type="submit" class="submit-btn">Post Listing</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Marketplace View Modal -->
        <div class="modal" id="marketplace-view-modal" style="display: none;">
          <div class="modal-content card" style="max-width: 760px;">
            <div class="modal-header">
              <h3 id="marketplace-view-title">Marketplace Listing</h3>
              <button class="modal-close" id="marketplace-view-close-btn">&times;</button>
            </div>
            <div class="city-modal-body">
              <img id="marketplace-view-image" alt="Listing image" style="width: 100%; max-height: 340px; object-fit: cover; border-radius: 10px; margin-bottom: 16px;">
              <div class="marketplace-item-meta" style="margin-bottom: 12px;">
                <span id="marketplace-view-price"></span>
                <span id="marketplace-view-location"></span>
                <span id="marketplace-view-date"></span>
              </div>
              <p id="marketplace-view-description"></p>
              <div style="margin-top: 16px;">
                <h4 style="margin-bottom: 8px;">Contact</h4>
                <p id="marketplace-view-contact"></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- City Page Modal -->
      <div class="modal" id="city-modal" style="display: none;">
        <div class="modal-content card" style="max-width: 800px;">
          <div class="modal-header">
            <h3 id="city-modal-title">City Name</h3>
            <button class="modal-close" id="city-modal-close">&times;</button>
          </div>
          <div class="city-modal-body">
            <div class="city-info">
              <p id="city-county-info" style="color: var(--wood-dark); margin-bottom: 20px;"></p>
              
              <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--wood-dark);">üìç Businesses in <span id="city-name-businesses"></span></h4>
              <div id="city-businesses-list" class="businesses-list">
                <p style="color: var(--ink-dark); font-style: italic;">No businesses registered yet.</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="nav-btn" id="city-modal-back">Back to County</button>
          </div>
        </div>
      </div>

      <!-- Business Submission Form -->
      <section class="form-section" id="business-form-section" style="display: none;">
        <div class="card form-card">
          <h2>Business Directory Listing</h2>
          <div class="form-group">
            <label>Choose Your Plan</label>
            <div class="form-row">
              <label class="card" style="padding: 12px; flex: 1; cursor: pointer;">
                <input type="radio" name="biz-plan" id="biz-plan-free" value="free" checked>
                <strong>Free</strong><br>
                <small>Basic listing</small><br>
                <small>$0 / month</small>
              </label>
              <label class="card" style="padding: 12px; flex: 1; cursor: pointer;">
                <input type="radio" name="biz-plan" id="biz-plan-pro" value="pro">
                <strong>Pro</strong><br>
                <small>Featured + leads + analytics</small><br>
                <small>$29 / month</small>
              </label>
              <label class="card" style="padding: 12px; flex: 1; cursor: pointer;">
                <input type="radio" name="biz-plan" id="biz-plan-premium" value="premium">
                <strong>Premium</strong><br>
                <small>Homepage feature + social shoutout</small><br>
                <small>$79 / month</small>
              </label>
            </div>
          </div>
          <form id="business-form">
            <div class="form-row">
              <div class="form-group">
                <label>Business Name</label>
                <input type="text" id="biz-name" required>
              </div>
              <div class="form-group">
                <label>County</label>
                <select id="biz-county" required>
                  <option value="">Select County...</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <select id="biz-city" required>
                  <option value="">Select County First...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Address</label>
                <input type="text" id="biz-address" placeholder="123 Main St" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="biz-phone" placeholder="(406) 555-0123">
              </div>
              <div class="form-group">
                <label>Website</label>
                <input type="url" id="biz-website" placeholder="https://example.com">
              </div>
            </div>
            <div class="form-group">
              <label>Icon</label>
              <input type="text" id="biz-icon" placeholder="üè™" maxlength="2">
            </div>
            <div class="form-group">
              <label>Billing Status</label>
              <select id="biz-billing-status">
                <option value="active" selected>Active</option>
                <option value="past_due">Past Due</option>
                <option value="canceled">Canceled</option>
              </select>
            </div>
            <button type="submit" class="submit-btn">Add Business Listing</button>
            <p class="form-note">Simple plans: Free, Pro, Premium ‚Äî upgrade anytime.</p>
          </form>
        </div>
      </section>

      <!-- Discussion Board Section -->
      <section class="discussion-section" id="discussion-section" style="display: none;">
        <div class="card discussion-card">
          <div class="discussion-header">
            <h2>üí¨ Montana Community Discussion</h2>
            <p class="discussion-subtitle">Share knowledge, ask questions, earn awards & climb the ranks</p>
          </div>

          <div class="discussion-layout">
            <!-- Leaderboard Sidebar -->
            <aside class="discussion-sidebar">
              <div class="leaderboard-section">
                <h3>üèÜ Top Members</h3>
                <div id="leaderboard" class="leaderboard-list">
                  <p class="empty-state">Loading members...</p>
                </div>
              </div>
              <div class="awards-section">
                <h3>üéñÔ∏è Your Awards</h3>
                <div id="user-awards" class="awards-display">
                  <p class="empty-state">Sign in to view awards</p>
                </div>
              </div>
            </aside>

            <!-- Main Discussion Area -->
            <div class="discussion-main">
              <!-- Post Creation Form -->
              <div class="post-form-wrapper card">
                <h3>Start a Discussion</h3>
                <form id="discussion-post-form">
                  <div class="form-group">
                    <label>Topic</label>
                    <input type="text" id="discussion-topic" placeholder="e.g., Best hiking spots in Montana..." maxlength="100" required>
                  </div>
                  <div class="form-group">
                    <label>Message</label>
                    <textarea id="discussion-message" placeholder="Share your Montana knowledge or ask a question..." rows="4" maxlength="500" required></textarea>
                  </div>
                  <div class="form-group">
                    <label>Category</label>
                    <select id="discussion-category" required>
                      <option value="">Select a category...</option>
                      <option value="wildlife">ü¶å Wildlife & Nature</option>
                      <option value="history">üìú History & Culture</option>
                      <option value="hiking">üèîÔ∏è Hiking & Outdoor</option>
                      <option value="cities">üèòÔ∏è Cities & Towns</option>
                      <option value="geology">ü™® Geology & Geography</option>
                      <option value="tips">üí° Local Tips & Advice</option>
                      <option value="general">üó®Ô∏è General Discussion</option>
                    </select>
                  </div>
                  <button type="submit" class="submit-btn">Post Discussion</button>
                </form>
              </div>

              <!-- Filter & Search -->
              <div class="discussion-filters card">
                <input type="text" id="discussion-search" placeholder="Search discussions..." class="search-input">
                <div class="filter-buttons">
                  <button class="filter-btn active" data-filter="all">All</button>
                  <button class="filter-btn" data-filter="wildlife">Wildlife</button>
                  <button class="filter-btn" data-filter="history">History</button>
                  <button class="filter-btn" data-filter="hiking">Hiking</button>
                  <button class="filter-btn" data-filter="cities">Cities</button>
                  <button class="filter-btn" data-filter="geology">Geology</button>
                  <button class="filter-btn" data-filter="tips">Tips</button>
                </div>
              </div>

              <!-- Discussions List -->
              <div id="discussions-list" class="discussions-list">
                <p class="empty-state">No discussions yet. Be the first to start one!</p>
              </div>

              <!-- Back Button -->
              <button id="discussion-close-btn" class="nav-btn" style="width: 100%; margin-top: 1.5rem;">Back to Map</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Discussion Post Edit Modal -->
      <div class="modal-overlay" id="discussion-edit-modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width:520px;width:96vw;">
          <div class="modal-header">
            <h3>‚úèÔ∏è Edit Post</h3>
            <button class="modal-close" id="discussion-edit-close-btn">‚úï</button>
          </div>
          <form id="discussion-edit-form" style="padding:0 var(--space-4) var(--space-4);">
            <input type="hidden" id="edit-post-id">
            <div class="form-group">
              <label for="edit-post-topic">Topic</label>
              <input type="text" id="edit-post-topic" maxlength="100" required placeholder="Discussion topic...">
            </div>
            <div class="form-group">
              <label for="edit-post-message">Message</label>
              <textarea id="edit-post-message" rows="5" maxlength="1000" required placeholder="Your message..."></textarea>
            </div>
            <div class="form-group">
              <label for="edit-post-category">Category</label>
              <select id="edit-post-category" required>
                <option value="wildlife">ü¶å Wildlife &amp; Nature</option>
                <option value="history">üìú History &amp; Culture</option>
                <option value="hiking">üèîÔ∏è Hiking &amp; Outdoor</option>
                <option value="cities">üèòÔ∏è Cities &amp; Towns</option>
                <option value="geology">ü™® Geology &amp; Geography</option>
                <option value="tips">üí° Local Tips &amp; Advice</option>
                <option value="general">üó®Ô∏è General Discussion</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="button" class="nav-btn" id="discussion-edit-cancel-btn">Cancel</button>
              <button type="submit" class="nav-btn auth-btn accent">Save Changes</button>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== AUTH SECTION (Sign In / Register / Forgot Password) ===== -->
      <section class="auth-section" id="auth-section" style="display: none;">
        <div class="card auth-card">
          <button class="auth-close-btn" id="auth-close-btn">&times;</button>
          
          <!-- Auth Tabs -->
          <div class="auth-tabs">
            <button class="auth-tab active" data-auth-tab="signin">Sign In</button>
            <button class="auth-tab" data-auth-tab="register">Register</button>
            <button class="auth-tab" data-auth-tab="forgot">Forgot Password</button>
          </div>

          <!-- Sign In Form -->
          <div class="auth-tab-content" id="auth-tab-signin">
            <div class="auth-header">
              <h2>Welcome Back</h2>
              <p>Sign in to your Montana Insight Portal account</p>
            </div>
            <div id="signin-error" class="auth-error" style="display: none;"></div>
            <form id="signin-form">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="signin-email" placeholder="your@email.com" required>
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" id="signin-password" placeholder="Enter password" required>
              </div>
              <button type="submit" class="submit-btn">Sign In</button>
              <p class="auth-link">Don't have an account? <a href="#" id="auth-goto-register">Register here</a></p>
              <p class="auth-link"><a href="#" id="auth-goto-forgot">Forgot your password?</a></p>
            </form>
          </div>

          <!-- Register Form -->
          <div class="auth-tab-content" id="auth-tab-register" style="display: none;">
            <div class="auth-header">
              <h2>Join Montana Insight Portal</h2>
              <p>Create your account and start earning awards</p>
            </div>
            <div id="register-error" class="auth-error" style="display: none;"></div>
            <form id="register-form">
              <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="register-name" placeholder="Your display name" maxlength="30" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="register-email" placeholder="your@email.com" required>
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" id="register-password" placeholder="Minimum 6 characters" minlength="6" required>
              </div>
              <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="register-confirm" placeholder="Confirm password" minlength="6" required>
              </div>
              <div class="form-group">
                <label>Choose Your Avatar</label>
                <div class="avatar-picker" id="avatar-picker">
                  <span class="avatar-option selected" data-emoji="üë§">üë§</span>
                  <span class="avatar-option" data-emoji="ü§†">ü§†</span>
                  <span class="avatar-option" data-emoji="ü¶å">ü¶å</span>
                  <span class="avatar-option" data-emoji="üêª">üêª</span>
                  <span class="avatar-option" data-emoji="üèîÔ∏è">üèîÔ∏è</span>
                  <span class="avatar-option" data-emoji="üå≤">üå≤</span>
                  <span class="avatar-option" data-emoji="ü¶Ö">ü¶Ö</span>
                  <span class="avatar-option" data-emoji="üê∫">üê∫</span>
                  <span class="avatar-option" data-emoji="üé£">üé£</span>
                  <span class="avatar-option" data-emoji="‚õ∑Ô∏è">‚õ∑Ô∏è</span>
                </div>
                <input type="hidden" id="register-avatar" value="üë§">
              </div>
              <button type="submit" class="submit-btn">Create Account</button>
              <p class="auth-link">Already have an account? <a href="#" id="auth-goto-signin">Sign in here</a></p>
            </form>
          </div>

          <!-- Forgot Password Form -->
          <div class="auth-tab-content" id="auth-tab-forgot" style="display: none;">
            <div class="auth-header">
              <h2>Reset Password</h2>
              <p>Enter your email to receive a password reset link</p>
            </div>
            <div id="forgot-error" class="auth-error" style="display: none;"></div>
            <div id="forgot-success" class="auth-success" style="display: none;"></div>
            <form id="forgot-form">
              <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="forgot-email" placeholder="your@email.com" required>
              </div>
              <button type="submit" class="submit-btn">Send Reset Link</button>
              <p class="auth-link"><a href="#" id="auth-goto-signin2">Back to Sign In</a></p>
            </form>
          </div>
        </div>
      </section>

      <!-- ===== USER PROFILE & SETTINGS ===== -->
      <section class="profile-section" id="profile-section" style="display: none;">
        <div class="card profile-card">
          <div class="profile-header">
            <h2>üë§ My Account</h2>
            <button class="nav-btn" id="profile-close-btn">‚Üê Back to Map</button>
          </div>

          <div class="profile-layout">

            <!-- ===== LEFT SIDEBAR ===== -->
            <div class="profile-sidebar">
              <!-- Avatar + Stats -->
              <div class="profile-overview">
                <div class="profile-avatar" id="profile-avatar-display">üë§</div>
                <h3 id="profile-display-name">Member</h3>
                <p class="profile-email-display" id="profile-email-display"></p>
                <span class="profile-rank" id="profile-rank">üë§ Member</span>
                <div class="profile-stats">
                  <div class="profile-stat">
                    <span class="stat-value" id="profile-total-points">0</span>
                    <span class="stat-label">Points</span>
                  </div>
                  <div class="profile-stat">
                    <span class="stat-value" id="profile-post-count">0</span>
                    <span class="stat-label">Posts</span>
                  </div>
                  <div class="profile-stat">
                    <span class="stat-value" id="profile-award-count">0</span>
                    <span class="stat-label">Awards</span>
                  </div>
                </div>
              </div>

              <!-- Tab Navigation -->
              <nav class="profile-nav">
                <button class="profile-nav-btn active" data-profile-tab="overview">üìä Overview</button>
                <button class="profile-nav-btn" data-profile-tab="edit">‚úèÔ∏è Edit Profile</button>
                <button class="profile-nav-btn" data-profile-tab="preferences">‚öôÔ∏è Preferences</button>
                <button class="profile-nav-btn" data-profile-tab="security">üîí Security</button>
              </nav>
            </div>

            <!-- ===== RIGHT CONTENT ===== -->
            <div class="profile-content">

              <!-- Overview Tab -->
              <div class="profile-tab-panel" id="profile-tab-overview">
                <div class="settings-block">
                  <h3>üéñÔ∏è My Awards</h3>
                  <div id="profile-awards-grid" class="profile-awards-grid">
                    <p class="empty-state">No awards earned yet. Start contributing in discussions!</p>
                  </div>
                </div>
                <div class="settings-block">
                  <h3>üìà Activity Summary</h3>
                  <div class="activity-summary-grid">
                    <div class="activity-item">
                      <span class="activity-icon">üí¨</span>
                      <div>
                        <strong id="activity-posts">0</strong>
                        <span>Discussion Posts</span>
                      </div>
                    </div>
                    <div class="activity-item">
                      <span class="activity-icon">‚≠ê</span>
                      <div>
                        <strong id="activity-points">0</strong>
                        <span>Total Points</span>
                      </div>
                    </div>
                    <div class="activity-item">
                      <span class="activity-icon">üèÖ</span>
                      <div>
                        <strong id="activity-awards">0</strong>
                        <span>Awards Earned</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Edit Profile Tab -->
              <div class="profile-tab-panel" id="profile-tab-edit" style="display:none;">
                <div class="settings-block">
                  <h3>‚úèÔ∏è Edit Profile</h3>
                  <form id="profile-settings-form">
                    <div class="form-group">
                      <label>Display Name</label>
                      <input type="text" id="profile-edit-name" placeholder="Your display name" maxlength="30">
                      <p class="form-note">This is how you appear in discussions and on the leaderboard.</p>
                    </div>
                    <div class="form-group">
                      <label>Bio <span style="font-weight:400; color: var(--mt-slate-400);">(<span id="bio-char-count">0</span>/200)</span></label>
                      <textarea id="profile-edit-bio" placeholder="Tell us about yourself and your Montana experience..." rows="4" maxlength="200"></textarea>
                    </div>
                    <div class="form-group">
                      <label>Choose Avatar</label>
                      <div class="avatar-picker" id="profile-avatar-picker">
                        <span class="avatar-option" data-emoji="üë§">üë§</span>
                        <span class="avatar-option" data-emoji="ü§†">ü§†</span>
                        <span class="avatar-option" data-emoji="ü¶å">ü¶å</span>
                        <span class="avatar-option" data-emoji="üêª">üêª</span>
                        <span class="avatar-option" data-emoji="üèîÔ∏è">üèîÔ∏è</span>
                        <span class="avatar-option" data-emoji="üå≤">üå≤</span>
                        <span class="avatar-option" data-emoji="ü¶Ö">ü¶Ö</span>
                        <span class="avatar-option" data-emoji="üê∫">üê∫</span>
                        <span class="avatar-option" data-emoji="üé£">üé£</span>
                        <span class="avatar-option" data-emoji="‚õ∑Ô∏è">‚õ∑Ô∏è</span>
                        <span class="avatar-option" data-emoji="üåæ">üåæ</span>
                        <span class="avatar-option" data-emoji="üê¥">üê¥</span>
                        <span class="avatar-option" data-emoji="ü¶¨">ü¶¨</span>
                        <span class="avatar-option" data-emoji="‚õ∫">‚õ∫</span>
                        <span class="avatar-option" data-emoji="üéø">üéø</span>
                        <span class="avatar-option" data-emoji="üåÑ">üåÑ</span>
                      </div>
                      <input type="hidden" id="profile-edit-avatar" value="üë§">
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="submit-btn">Save Profile</button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Preferences Tab -->
              <div class="profile-tab-panel" id="profile-tab-preferences" style="display:none;">
                <form id="profile-privacy-form">
                  <div class="settings-block">
                    <h3>üîç Privacy</h3>
                    <div class="settings-row">
                      <div class="settings-row-info">
                        <strong>Show on Public Leaderboard</strong>
                        <p>Allow your name and points to appear in the community Top 20 leaderboard.</p>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" id="profile-show-leaderboard" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="settings-row">
                      <div class="settings-row-info">
                        <strong>Public Profile</strong>
                        <p>Let other members see your profile, bio, and awards.</p>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" id="profile-public-profile" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="settings-block">
                    <h3>üîî Notifications</h3>
                    <div class="settings-row">
                      <div class="settings-row-info">
                        <strong>Email Notifications</strong>
                        <p>Receive email updates about replies to your posts and new awards earned.</p>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" id="profile-email-notifications" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="submit-btn">Save Preferences</button>
                  </div>
                </form>
              </div>

              <!-- Security Tab -->
              <div class="profile-tab-panel" id="profile-tab-security" style="display:none;">
                <div class="settings-block">
                  <h3>üìß Account Information</h3>
                  <div class="account-info-row">
                    <span class="account-info-label">Email Address</span>
                    <span class="account-info-value" id="profile-account-email">‚Äî</span>
                  </div>
                  <div class="account-info-row">
                    <span class="account-info-label">Member Since</span>
                    <span class="account-info-value" id="profile-member-since">‚Äî</span>
                  </div>
                  <div class="account-info-row">
                    <span class="account-info-label">Total Posts</span>
                    <span class="account-info-value" id="profile-account-posts">‚Äî</span>
                  </div>
                </div>

                <div class="settings-block">
                  <h3>üîë Change Password</h3>
                  <form id="user-password-form">
                    <div id="user-password-error" class="auth-error" style="display:none;"></div>
                    <div id="user-password-success" class="auth-success" style="display:none;"></div>
                    <div class="form-group">
                      <label>Current Password</label>
                      <input type="password" id="user-current-password" placeholder="Enter your current password">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="user-new-password" placeholder="Minimum 6 characters" minlength="6">
                      </div>
                      <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="user-confirm-password" placeholder="Repeat new password">
                      </div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="submit-btn">Update Password</button>
                    </div>
                  </form>
                </div>

                <div class="settings-block danger-zone">
                  <h3>‚ö†Ô∏è Account Actions</h3>
                  <p style="color: var(--mt-slate-600); margin-bottom: var(--space-4);">Sign out of your account on this device.</p>
                  <button class="submit-btn danger" id="profile-signout-btn" type="button">Sign Out</button>
                </div>
              </div>

            </div><!-- /.profile-content -->
          </div><!-- /.profile-layout -->
        </div><!-- /.profile-card -->
      </section>

      <!-- ===== TOP 20 AWARDS & LEADERBOARD PAGE ===== -->
      <section class="awards-page-section" id="awards-page-section" style="display: none;">
        <div class="card awards-page-card">
          <div class="awards-page-header">
            <h2>üèÜ Montana Insight Portal Top 20 Leaderboard</h2>
            <p class="awards-page-subtitle">The most knowledgeable and helpful Montana community members</p>
            <button class="nav-btn" id="awards-page-close-btn">Back to Map</button>
          </div>

          <!-- Leaderboard -->
          <div class="awards-leaderboard-section">
            <div class="top3-podium" id="top3-podium">
              <!-- Filled by JS -->
            </div>
            <div class="full-leaderboard" id="full-leaderboard">
              <!-- Filled by JS -->
            </div>
          </div>

          <!-- All Available Awards -->
          <div class="all-awards-section">
            <h3>üéñÔ∏è Available Awards</h3>
            <p class="awards-section-subtitle">Earn these awards by contributing knowledge, completing quizzes, and exploring Montana</p>
            <div class="awards-catalog" id="awards-catalog">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- ===== COMMUNITY EVENTS SECTION ===== -->
      <section class="events-section" id="events-section" style="display:none;">
        <div class="card events-card">
          <div class="events-section-header">
            <div class="events-header-left">
              <h2>üìÖ Community Events</h2>
              <p class="events-subtitle">Discover and share events across Montana</p>
            </div>
            <div class="events-header-actions">
              <button class="events-add-btn" id="events-add-btn" style="display:none;">+ Add Your Event</button>
              <button class="nav-btn" id="events-close-btn">‚úï Close</button>
            </div>
          </div>

          <div class="events-filters">
            <input type="text" id="events-search" class="search-input" placeholder="Search events...">
            <select id="events-filter-type" class="search-input">
              <option value="">All Types</option>
              <option value="community">üéâ Community</option>
              <option value="outdoor">üèîÔ∏è Outdoor &amp; Recreation</option>
              <option value="arts">üé® Arts &amp; Culture</option>
              <option value="business">üè™ Business</option>
              <option value="historical">üìú Historical</option>
              <option value="sports">‚öΩ Sports</option>
              <option value="food">üçΩÔ∏è Food &amp; Drink</option>
              <option value="other">üóìÔ∏è Other</option>
            </select>
            <select id="events-filter-county" class="search-input">
              <option value="">All Counties</option>
            </select>
          </div>

          <div id="public-events-grid" class="public-events-grid">
            <div class="events-loading">Loading events...</div>
          </div>
        </div>
      </section>

      <!-- Add Event Modal (logged-in users) -->
      <div class="modal-overlay" id="user-event-modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-content events-modal-content">
          <div class="modal-header">
            <h3>üìÖ Add Your Event</h3>
            <button class="modal-close" id="user-event-modal-close">‚úï</button>
          </div>
          <form id="user-event-form" class="events-form">
            <div class="form-section-title">Event Details</div>
            <div class="form-group">
              <label for="ue-name">Event Name *</label>
              <input type="text" id="ue-name" required placeholder="e.g. Annual Flathead Lake Festival">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="ue-type">Event Type *</label>
                <select id="ue-type" required>
                  <option value="community">üéâ Community</option>
                  <option value="outdoor">üèîÔ∏è Outdoor &amp; Recreation</option>
                  <option value="arts">üé® Arts &amp; Culture</option>
                  <option value="business">üè™ Business</option>
                  <option value="historical">üìú Historical</option>
                  <option value="sports">‚öΩ Sports</option>
                  <option value="food">üçΩÔ∏è Food &amp; Drink</option>
                  <option value="other">üóìÔ∏è Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="ue-county">County *</label>
                <select id="ue-county" required>
                  <option value="">Select County...</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="ue-city">City / Area</label>
              <input type="text" id="ue-city" placeholder="e.g. Kalispell, Big Sky">
            </div>
            <div class="form-group">
              <label for="ue-description">Description *</label>
              <textarea id="ue-description" rows="3" required placeholder="Describe your event..."></textarea>
            </div>

            <div class="form-section-title">Date &amp; Time</div>
            <div class="form-row">
              <div class="form-group">
                <label for="ue-start">Start Date *</label>
                <input type="date" id="ue-start" required>
              </div>
              <div class="form-group">
                <label for="ue-end">End Date</label>
                <input type="date" id="ue-end">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="ue-start-time">Start Time</label>
                <input type="time" id="ue-start-time">
              </div>
              <div class="form-group">
                <label for="ue-end-time">End Time</label>
                <input type="time" id="ue-end-time">
              </div>
            </div>

            <div class="form-section-title">Location &amp; Contact</div>
            <div class="form-group">
              <label for="ue-address">Address / Venue</label>
              <input type="text" id="ue-address" placeholder="e.g. 123 Main St, Missoula MT">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="ue-website">Website / Tickets URL</label>
                <input type="text" id="ue-website" placeholder="https://...">
              </div>
              <div class="form-group">
                <label for="ue-price">Price / Admission</label>
                <input type="text" id="ue-price" placeholder="e.g. Free, $10">
              </div>
            </div>
            <div class="form-group">
              <label for="ue-contact-email">Contact Email</label>
              <input type="email" id="ue-contact-email" placeholder="organizer@example.com">
            </div>

            <div id="user-event-error" class="auth-error" style="display:none;"></div>
            <div class="form-actions">
              <button type="button" class="nav-btn" id="user-event-cancel">Cancel</button>
              <button type="submit" class="nav-btn auth-btn accent" id="user-event-submit-btn">Submit Event</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Event Detail & Share Modal -->
      <div class="modal-overlay" id="event-detail-modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-content event-detail-modal-content">
          <div class="modal-header">
            <h3 id="event-detail-title">Event Details</h3>
            <button class="modal-close" id="event-detail-close">‚úï</button>
          </div>
          <div class="event-detail-body">
            <div class="event-detail-badge-row">
              <span class="event-type-chip" id="event-detail-type-chip"></span>
              <span class="event-detail-county" id="event-detail-county"></span>
            </div>
            <div class="event-detail-dates" id="event-detail-dates"></div>
            <div class="event-detail-address" id="event-detail-address"></div>
            <p class="event-detail-description" id="event-detail-description"></p>
            <div class="event-detail-meta" id="event-detail-meta"></div>

            <div class="event-share-section">
              <h4>üì¢ Share This Event</h4>
              <div class="event-share-btns">
                <button class="share-btn share-facebook" id="share-facebook">üìò Facebook</button>
                <button class="share-btn share-twitter" id="share-twitter">ùïè Twitter / X</button>
                <button class="share-btn share-reddit" id="share-reddit">üü† Reddit</button>
                <button class="share-btn share-email" id="share-email">üìß Email</button>
                <button class="share-btn share-copy" id="share-copy">üîó Copy Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <section class="map-section" id="map-section">
        <div class="map-header">
          <div class="map-header-row">
            <div>
              <h2>Interactive County Map</h2>
              <p class="map-description">Click any county to view details</p>
            </div>
            <button class="map-toggle-btn" id="map-toggle-btn" title="Hide map">
              <svg id="map-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
              <span id="map-toggle-label">Hide Map</span>
            </button>
          </div>
        </div>
        <div id="map-collapsible" class="map-collapsible">
        <div id="map"></div>
        
        </div><!-- end map-collapsible -->

        <!-- Layer Controller -->
        <div class="layer-controller" id="layer-controller">
          <div class="layer-header" id="layer-header">
            <span class="layer-drag-handle" title="Drag to move">‚ãÆ‚ãÆ</span>
            <h3>üó∫Ô∏è Explorer Layers</h3>
            <div class="layer-header-buttons">
              <button class="layer-minimize-btn" id="layer-minimize-btn" title="Minimize">‚àí</button>
              <button class="layer-toggle-btn" id="layer-toggle-btn" title="Collapse">‚óÄ</button>
            </div>
          </div>
          
          <div class="layer-group layer-group-trails">
            <h4>ü•æ Trails &amp; Routes</h4>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="hiking-trails">
              <span>ü•æ Hiking Trails <span class="layer-badge">USFS</span></span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="scenic-byways">
              <span>üõ£Ô∏è Scenic Byways</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="fishing-access">
              <span>üé£ Fishing Access <span class="layer-badge">FWP</span></span>
            </label>
          </div>

          <div class="layer-group">
            <h4>üå≤ Nature</h4>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="watersheds">
              <span>üíß Watersheds</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="grizzly">
              <span>üêª Grizzly Ranges</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="peaks">
              <span>‚õ∞Ô∏è Mountain Peaks</span>
            </label>
          </div>
          
          <div class="layer-group">
            <h4>üìú History</h4>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="lewis-clark">
              <span>üõ∂ Lewis & Clark Trail</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="native-lands">
              <span>üèõÔ∏è Native Ancestral Lands</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="ghost-towns">
              <span>üëª Ghost Towns <span class="layer-badge">Status</span></span>
            </label>
          </div>

          <div class="layer-group">
            <h4>üïµÔ∏è Hidden History</h4>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="copper-king-era">
              <span>‚õèÔ∏è Layer A: Copper King Era</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="indigenous-heritage">
              <span>ü™∂ Layer B: Indigenous Heritage</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="film-locations">
              <span>üé¨ Layer C: Film Locations</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="wildlife-hotspots">
              <span>ü¶¢ Layer D: Wildlife Hotspots</span>
            </label>
          </div>
          
          <div class="layer-group">
            <h4>üè≠ Industry</h4>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="mines">
              <span>‚õèÔ∏è Active Mines</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="agriculture">
              <span>üåæ Agriculture Zones</span>
            </label>
            <label class="layer-item">
              <input type="checkbox" class="layer-checkbox" data-layer="wind-farms">
              <span>üí® Wind Farms</span>
            </label>
          </div>
        </div>
        
        <!-- Interactive HUD -->
        <div class="hud-panel" id="hud-panel">
          <div class="hud-header">
            <span class="hud-title">üí° Did You Know?</span>
            <button class="hud-close" id="hud-close">√ó</button>
          </div>
          <div class="hud-content" id="hud-content">
            <p>Explore the map to discover fascinating facts about Montana's regions, history, and natural wonders!</p>
          </div>
          <div class="hud-footer">
            <span class="hud-location" id="hud-location">Montana</span>
          </div>
        </div>

        <div class="map-insights-grid">
          <section class="map-widget big-sky-widget" id="big-sky-dashboard">
            <div class="map-widget-header">
              <h3>üèîÔ∏è Big Sky Dashboard</h3>
              <div class="big-sky-tools">
                <button class="nav-btn" id="big-sky-refresh-btn" type="button">Refresh</button>
                <div class="big-sky-legend-wrap">
                  <button class="nav-btn big-sky-legend-btn" id="big-sky-legend-btn" type="button" aria-label="Show data sources">‚ìò Sources</button>
                  <div class="big-sky-legend-tooltip" id="big-sky-legend-tooltip" role="note">
                    <strong>Data Sources</strong>
                    <p>Snowpack: USDA NRCS AWDB SNOTEL daily SWE observations.</p>
                    <p>Streamflow: USGS NWIS instantaneous discharge (cfs).</p>
                    <p id="big-sky-legend-meta">Latest timestamps loading...</p>
                    <p class="legend-caveat">Caveat: station outages, telemetry lag, and seasonal access can delay updates.</p>
                  </div>
                </div>
              </div>
            </div>
            <p class="map-widget-subtitle">Montana at a glance: snowpack, river flow, and today in history.</p>
            <div class="big-sky-grid">
              <div>
                <h4>Current SNOTEL Snowpack</h4>
                <div id="big-sky-snotel" class="big-sky-list">
                  <p class="empty-state">Loading SNOTEL data...</p>
                </div>
              </div>
              <div>
                <h4>Major River Streamflow</h4>
                <div id="big-sky-streamflow" class="big-sky-list">
                  <p class="empty-state">Loading streamflow data...</p>
                </div>
              </div>
            </div>
            <div class="big-sky-fact" id="big-sky-fact">
              <h4>üìö History Fact of the Day</h4>
              <p class="empty-state">Loading historical fact...</p>
            </div>
            <p class="big-sky-updated" id="big-sky-updated">Last refresh: --</p>
          </section>

          <section class="map-widget ghost-town-widget" id="ghost-town-tracker">
            <div class="map-widget-header">
              <h3>üëª Ghost Town Status Tracker</h3>
            </div>
            <p class="map-widget-subtitle">Preservation meter, accessibility status, and teacher notes curated for field learning.</p>
            <div id="ghost-town-status-list" class="ghost-town-status-list">
              <p class="empty-state">Loading ghost town statuses...</p>
            </div>
          </section>
        </div>
      </section>

      <!-- Information Grid -->
      <section class="info-grid" id="info-section" style="display: none;">
        <div class="card">
          <h3>Mountain Passes</h3>
          <div id="passes-list" class="content-list">
            <p class="empty-state">No data available</p>
          </div>
        </div>
        <div class="card">
          <h3>Weather Stations</h3>
          <div id="weather-stations" class="content-list">
            <p class="empty-state">No data available</p>
          </div>
        </div>
        <div class="card">
          <h3>Local Businesses</h3>
          <div id="business-list" class="content-list">
            <p class="empty-state">No listings yet</p>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; 2026 Montana Insight Portal</p>
      <p class="last-updated" id="last-updated"></p>
      <button id="admin-btn" class="admin-access-button" title="Admin Panel Access">‚öôÔ∏è</button>
    </footer>
  </div>

  <!-- Firebase compat SDK (only loaded if you configure firebase-config.js) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script type="module" src="config.js?v=20260219b"></script>
  <script type="module" src="firebase-config.js?v=20260219b"></script>
  <script type="module" src="app.js?v=20260219b"></script>
</body>
</html>